<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>TokenMate AI</title>
  <style>
    :root{
      --bg:#0b0f1a;
      --panel:#111827;
      --header:#020617;
      --accent:#22d3ee;
      --muted:#9ca3af;
      --text:#e5e7eb;
    }
    *{ box-sizing:border-box; }
    html, body { height:100%; }
    body{
      margin:0;
      font-family: Arial, sans-serif;
      background:var(--bg);
      color:var(--text);
      min-height:100%;
      display:flex;
      flex-direction:column;
    }

    /* Header */
    header{
      background:var(--header);
      padding:12px 14px;
      text-align:center;
      font-weight:700;
      color:var(--accent);
      flex:0 0 auto;
    }
    .disclaimer{
      margin-top:4px;
      font-size:12px;
      color:var(--muted);
      font-weight:400;
      opacity:.9;
    }

    /* Tabs */
    nav{
      background:var(--header);
      display:flex;
      gap:0;
      border-bottom:1px solid rgba(255,255,255,.06);
      flex:0 0 auto;
    }
    nav button{
      flex:1;
      padding:12px;
      background:transparent;
      border:0;
      color:var(--muted);
      cursor:pointer;
      font-weight:600;
    }
    nav button.active{
      color:var(--accent);
      border-bottom:2px solid var(--accent);
    }

    /* Main area */
    main{
      flex:1 1 auto;
      min-height:0; /* IMPORTANT: allows scrolling inside */
      display:flex;
      flex-direction:column;
    }

    .view{
      display:none;
      padding:14px;
      overflow:auto;
      flex:1 1 auto;
      min-height:0;
    }
    .view.active{ display:block; }

    .card{
      background:var(--panel);
      border-radius:14px;
      padding:14px;
      margin-bottom:12px;
      border:1px solid rgba(255,255,255,.06);
    }

    /* Chat */
    .messages{
      display:flex;
      flex-direction:column;
      gap:10px;
      padding-bottom:12px;
    }
    .message{
      max-width:78%;
      padding:12px;
      border-radius:12px;
      line-height:1.35;
      white-space:pre-wrap;
      word-break:break-word;
    }
    .message.ai{
      background:var(--panel);
      align-self:flex-start;
    }
    .message.user{
      background:var(--accent);
      color:var(--header);
      align-self:flex-end;
    }

    .composer{
      display:flex;
      gap:10px;
      padding:12px;
      background:var(--header);
      border-top:1px solid rgba(255,255,255,.06);
      flex:0 0 auto;
    }
    .composer input{
      flex:1;
      border:1px solid rgba(255,255,255,.10);
      background:#0f172a;
      color:var(--text);
      padding:12px;
      border-radius:12px;
      outline:none;
    }
    .composer button{
      border:0;
      background:var(--accent);
      color:var(--header);
      font-weight:700;
      padding:12px 16px;
      border-radius:12px;
      cursor:pointer;
      white-space:nowrap;
    }
    .composer button:disabled{
      opacity:.6;
      cursor:not-allowed;
    }
  </style>
</head>

<body>
  <header>
    TokenMate AI
    <div class="disclaimer">‚ö†Ô∏è Educational purposes only ‚Äî not financial advice.</div>
  </header>

  <nav>
    <button id="tab-chat" class="active" type="button">Chat</button>
    <button id="tab-portfolio" type="button">Portfolio</button>
    <button id="tab-builder" type="button">App Builder</button>
  </nav>

  <main>
    <!-- CHAT VIEW -->
    <section id="view-chat" class="view active" aria-label="Chat">
      <div class="messages" id="messages">
        <div class="message ai">üëã Welcome to TokenMate AI. Ask me about crypto or app ideas.</div>
      </div>
    </section>

    <!-- PORTFOLIO VIEW -->
   <section id="view-portfolio" class="view" aria-label="Portfolio">
  <div class="card">
    <h3 style="margin:0 0 10px 0;">Your Portfolio</h3>

    <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
      <div class="card" style="margin:0;">
        <div style="color:var(--muted); font-size:12px;">BTC Price</div>
        <div id="p-btc" style="font-size:18px; font-weight:700; margin-top:4px;">‚Äî</div>
        <div id="c-btc" style="color:var(--muted); font-size:12px; margin-top:4px;">‚Äî</div>
      </div>

      <div class="card" style="margin:0;">
        <div style="color:var(--muted); font-size:12px;">ETH Price</div>
        <div id="p-eth" style="font-size:18px; font-weight:700; margin-top:4px;">‚Äî</div>
        <div id="c-eth" style="color:var(--muted); font-size:12px; margin-top:4px;">‚Äî</div>
      </div>
    </div>

    <div class="card" style="margin-top:12px;">
      <div style="display:flex; justify-content:space-between; gap:10px; align-items:center;">
        <div>
          <div style="color:var(--muted); font-size:12px;">Your Holdings (edit)</div>
          <div style="display:flex; gap:10px; margin-top:8px;">
            <div style="flex:1;">
              <div style="color:var(--muted); font-size:12px;">BTC</div>
              <input id="h-btc" type="number" step="0.0001" placeholder="0.00" />
            </div>
            <div style="flex:1;">
              <div style="color:var(--muted); font-size:12px;">ETH</div>
              <input id="h-eth" type="number" step="0.0001" placeholder="0.00" />
            </div>
          </div>
        </div>
      </div>

      <button id="savePortfolioBtn" style="margin-top:12px; width:100%;" type="button">Save Holdings</button>

      <div style="margin-top:12px; color:var(--muted); font-size:12px;">Estimated Total Value</div>
      <div id="totalValue" style="font-size:20px; font-weight:800; margin-top:6px;">$0.00</div>
    </div>
  </div>
</section>


    <!-- BUILDER VIEW -->
    <section id="view-builder" class="view" aria-label="App Builder">
      <div class="card">
        <h3 style="margin:0 0 10px 0;">Create an App</h3>
        <div style="color:var(--muted); margin-bottom:10px;">
          Describe your app idea and TokenMate will help generate it (coming soon).
        </div>
        <input id="builderInput" placeholder="Example: A BTC price alert app with subscriptions..." />
        <button style="margin-top:10px; width:100%;" disabled>Generate App (Coming Soon)</button>
      </div>
    </section>

    <!-- COMPOSER (fixed area, always clickable) -->
    <div class="composer">
      <input id="chatInput" placeholder="Ask TokenMate..." autocomplete="off" />
      <button id="sendBtn" type="button">Send</button>
    </div>
  </main>

  <script>
    // Tab switching (NO event.target usage ‚Äî fixes Chromebook/mobile issues)
    const tabs = {
      chat: document.getElementById("tab-chat"),
      portfolio: document.getElementById("tab-portfolio"),
      builder: document.getElementById("tab-builder"),
    };
    const views = {
      chat: document.getElementById("view-chat"),
      portfolio: document.getElementById("view-portfolio"),
      builder: document.getElementById("view-builder"),
    };

    function setActive(tabName){
      Object.keys(tabs).forEach(k => tabs[k].classList.toggle("active", k === tabName));
      Object.keys(views).forEach(k => views[k].classList.toggle("active", k === tabName));
    }

    tabs.chat.addEventListener("click", () => setActive("chat"));
    tabs.portfolio.addEventListener("click", () => setActive("portfolio"));
    tabs.builder.addEventListener("click", () => setActive("builder"));

    // Real AI
    let chatHistory = [];
    const messagesEl = document.getElementById("messages");
    const inputEl = document.getElementById("chatInput");
    const sendBtn = document.getElementById("sendBtn");

    async function sendChat(){
      const text = inputEl.value.trim();
      if(!text) return;
// ===== Portfolio: live prices + totals (CoinGecko) =====
let lastPrices = { btc: null, eth: null };

function fmtUSD(n){
  if (typeof n !== "number") return "‚Äî";
  return "$" + n.toLocaleString(undefined, { maximumFractionDigits: 2 });
}

function fmtPct(n){
  if (typeof n !== "number") return "‚Äî";
  const sign = n >= 0 ? "+" : "";
  return `${sign}${n.toFixed(2)}% (24h)`;
}

async function refreshPortfolioPrices(){
  try{
    const url = "https://api.coingecko.com/api/v3/simple/price?ids=bitcoin,ethereum&vs_currencies=usd&include_24hr_change=true";
    const r = await fetch(url);
    const d = await r.json();

    const btc = d?.bitcoin?.usd;
    const btcCh = d?.bitcoin?.usd_24h_change;
    const eth = d?.ethereum?.usd;
    const ethCh = d?.ethereum?.usd_24h_change;

    lastPrices.btc = btc;
    lastPrices.eth = eth;

    const pBtc = document.getElementById("p-btc");
    const cBtc = document.getElementById("c-btc");
    const pEth = document.getElementById("p-eth");
    const cEth = document.getElementById("c-eth");

    if (pBtc) pBtc.textContent = fmtUSD(btc);
    if (cBtc) cBtc.textContent = fmtPct(btcCh);
    if (pEth) pEth.textContent = fmtUSD(eth);
    if (cEth) cEth.textContent = fmtPct(ethCh);

    recomputeTotal();
  } catch(e){
    // leave existing UI as-is if rate-limited or offline
  }
}

function recomputeTotal(){
  const btcAmt = parseFloat(document.getElementById("h-btc")?.value || "0") || 0;
  const ethAmt = parseFloat(document.getElementById("h-eth")?.value || "0") || 0;
  const btcVal = (lastPrices.btc || 0) * btcAmt;
  const ethVal = (lastPrices.eth || 0) * ethAmt;
  const total = btcVal + ethVal;

  const totalEl = document.getElementById("totalValue");
  if (totalEl) totalEl.textContent = fmtUSD(total);
}

// Load & save holdings locally (so user doesn't lose it on refresh)
function loadHoldings(){
  try{
    const saved = JSON.parse(localStorage.getItem("tm_holdings") || "{}");
    if (typeof saved.btc === "number") document.getElementById("h-btc").value = saved.btc;
    if (typeof saved.eth === "number") document.getElementById("h-eth").value = saved.eth;
  } catch(e){}
}

function saveHoldings(){
  const btc = parseFloat(document.getElementById("h-btc").value || "0") || 0;
  const eth = parseFloat(document.getElementById("h-eth").value || "0") || 0;
  localStorage.setItem("tm_holdings", JSON.stringify({ btc, eth }));
  recomputeTotal();
}

// Wire events after page loads
window.addEventListener("DOMContentLoaded", () => {
  const saveBtn = document.getElementById("savePortfolioBtn");
  if (saveBtn) saveBtn.addEventListener("click", saveHoldings);

  const hb = document.getElementById("h-btc");
  const he = document.getElementById("h-eth");
  if (hb) hb.addEventListener("input", recomputeTotal);
  if (he) he.addEventListener("input", recomputeTotal);

  loadHoldings();
  refreshPortfolioPrices();
  setInterval(refreshPortfolioPrices, 60_000); // refresh every 60s
});

      // Ensure we are on chat view
      setActive("chat");

      // Render user bubble
      const u = document.createElement("div");
      u.className = "message user";
      u.textContent = text;
      messagesEl.appendChild(u);

      inputEl.value = "";
      inputEl.focus();

      chatHistory.push({ role:"user", content:text });

      // Thinking bubble
      const a = document.createElement("div");
      a.className = "message ai";
      a.textContent = "ü§ñ TokenMate is thinking...";
      messagesEl.appendChild(a);
      messagesEl.scrollTop = messagesEl.scrollHeight;

      sendBtn.disabled = true;

      try{
        const r = await fetch("/api/chat", {
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify({ message: text, history: chatHistory })
        });

        const data = await r.json();
        const reply = data.reply || data.error || "‚ö†Ô∏è No response from AI.";

        a.textContent = reply;
        chatHistory.push({ role:"assistant", content: reply });
      }catch(e){
        a.textContent = "‚ùå Error connecting to AI.";
      }finally{
        sendBtn.disabled = false;
        messagesEl.scrollTop = messagesEl.scrollHeight;
      }
    }

    sendBtn.addEventListener("click", sendChat);
    inputEl.addEventListener("keydown", (e) => {
      if(e.key === "Enter") sendChat();
    });
  </script>
</body>
</html>
